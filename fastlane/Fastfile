fastlane_require 'yaml'
fastlane_version "2.105.2"

setup_travis

default_platform(:ios)

platform :ios do

  lane :tests do

    libraries
    
    run_tests(
      scheme: ENV['PROJECT_SCHEME'],
      sdk: "iphonesimulator",
      devices: ["iPhone X"],
      clean: true
    )

  end

  lane :release do

    libraries
    
    increment_version

    config_documentation

  end

  lane :config_documentation do

    jazzy(
      config: ".jazzy.yaml"
    )

  end

  private_lane :increment_version do 

    version_number = (YAML::load_file(File.join(__dir__, ENV['VERSION_FILE'])))['version']
    
    major, minor, patch = version_number.split(".")
    patch = patch.to_i + 1

    version_number = "#{major}.#{minor}.#{patch}"

    File.open(ENV['VERSION_FILE'], 'w') {|f| f.write "version: #{version_number}" }

    increment_version_number(
      version_number: version_number
    )

    version_bump_podspec(
      path: ENV['PODSPEC_NAME'],
      version_number: version_number
    )

  end

  private_lane :libraries do 

    carthage(
      platform: "iOS"
    )

  end

end
