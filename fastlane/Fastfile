fastlane_require 'yaml'
fastlane_version "2.105.2"

setup_travis

default_platform(:ios)

platform :ios do

  lane :tests do

    libraries
    
    run_tests(
      scheme: ENV['PROJECT_SCHEME'],
      sdk: "iphonesimulator",
      devices: ["iPhone X"],
      clean: true
    )

  end

  lane :network_tests do 

    config_project_for_network_test

    libraries
    
    run_tests(
       scheme: ENV['PROJECT_NETWORK_SCHEME'] 
       sdk: "iphonesimulator",
       devices: ["iPhone X"],
       clean: true
    )

  end

  private_lane :config_project_for_network_test do

    constants_keys = ENV['CONSTANTS_KEYS']
    constants_array = constants_keys.split(' ')

    first_constant_key = constants_array.first
    first_constant_value = ENV[first_constant_key]

    sh("./appendConstantsToConfig.sh #{first_constant_key} #{first_constant_value} true")

    for i in 1..constants_array.count-1
      constant_key = constants_array[i]
      constant_value = ENV[constant_key]

      sh("./appendConstantsToConfig.sh #{constant_key} #{constant_value}")
    end

  end

  lane :release do

    libraries
    
    increment_version

    config_documentation

  end

  lane :config_documentation do

    jazzy(
      config: ".jazzy.yaml"
    )

  end

  private_lane :increment_version do 

    version_number = (YAML::load_file(File.join(__dir__, ENV['VERSION_FILE'])))['version']
    
    major, minor, patch = version_number.split(".")
    patch = patch.to_i + 1

    version_number = "#{major}.#{minor}.#{patch}"

    File.open(ENV['VERSION_FILE'], 'w') {|f| f.write "version: #{version_number}" }

    increment_version_number(
      version_number: version_number
    )

    version_bump_podspec(
      path: ENV['PODSPEC_NAME'],
      version_number: version_number
    )

  end

  private_lane :libraries do 

    carthage(
      platform: "iOS"
    )

  end

end